<!--
 This build file contains all the different statistics and snapshot
 built by the argouml-gen project.
 
 To take part in this you:
 1. Install cvs.
 2. Check out this file:
     cvs co -d :pserver:guest@cvs.tigris.org:/cvs argouml-gen/build.xml
 3. Install ant.
 4. Run through everything:
     ant -logger org.apache.tools.ant.XmlLogger -logfile www/logs/<your tigris id>/log00001.xml
 5. Decide on what parts of this you are willing to run.
    Default is everything.
    Options are:
      javadoc
      daily build (not yet implemented)
      commit statistics (NYI)
      issuezilla statistics (NYI)
      mailinglist statistics (NYI)
 6. Set up the cron job to run this regularly.
 7. Apply for a role in this project.
 8. Get the role granted.
 9. Create the result directories in cvs.
10. Monitor your commits.

 The general design of these targets is that they run in a directory called
 tmp that is created on the first invocation and that can be removed at any
 time (after completion or between runs).
 All data or result is then copied to and commited somewhere in the www tree.

 Things that are snapshots from the source that depend on things like OS and 
 JDK version that are not part of neither the argouml-gen, nor the argouml
 project, are located in subdirectories in www that are instance specific
 like www/snapshots/<user>/os/jdk. These targets rely heavily on the 
 corresponding targets in argouml/src_new/build.xml.

 Things that are independant are located in directories directly under www 
 like www/issuezilla.

 Logs are located under www/logs/<user>/ and they are new for each invocation.
 -->

<project name="argouml-gen" default="all" basedir=".">
  <description>
        Build some targets in another project and save results to CVS.
    </description>
  <!-- set global properties for this build -->
  <property file="build.properties"/>
  <property name="cvs.user" value="${user.name}"/>
  <property name="cvs.root" value=":pserver:${cvs.user}@cvs.tigris.org:/cvs"/>
  <property name="project.to.build" value="argouml"/>
  <property name="working.dir" location="${basedir}/tmp"/>
  <property name="argouml.dir" location="${working.dir}/argouml"/>
  <property name="argouml.src.dir" location="${argouml.dir}/src_new"/>
  
  <property name="xsl.dir" location="${basedir}/xsl"/>

  <property name="instrument-ant.xsl" location="${xsl.dir}/instrument-ant.xsl"/>

  <target name="init">
    <!-- Common initializations. -->
    <mkdir dir="${working.dir}"/>
  </target>


  <target name="all" depends="compile,javadocs,tests" description="do everything"></target>


  <!-- Copying and commiting one directory tree -->
  <!-- Source is fromdir an existing directory with contents. -->
  <!-- Target is todir a possibly not created path in the argouml-gen 
       project cvs repository 
    -->
  <target name="commit-files">
    <cvs cvsRoot="${cvs.root}" command="update -Ad" dest="${todir}"/>
    <mkdir dir="${todir}"/>
    <delete>
      <fileset dir="${todir}" excludes="CVS CVS/*"/>
    </delete>
    <copy todir="${todir}">
      <fileset dir="${fromdir}"/>
    </copy>

    <!-- WARNING! This is not portable! Please help in improving it! -->
    <!-- Remove no longer needed files -->
    <exec executable="sh">
      <arg value="-c"/>
      <arg value="cd ${todir} ; cvs -nq update | grep -e '^U' | while read comm file; do ( cd `dirname $$file` ; cvs remove `basename $$file` ); done"/>
    </exec>

    <!-- Add new files -->
    <!-- one time for every level of directory -->
    <exec executable="sh">
      <arg value="-c"/>
      <arg value="cd ${todir} ; cvs -nq update | grep -e '^?' | while read comm file; do ( cd `dirname $$file` ; cvs add `basename $$file` ); done"/>
    </exec>
    <exec executable="sh">
      <arg value="-c"/>
      <arg value="cd ${todir} ; cvs -nq update | grep -e '^?' | while read comm file; do ( cd `dirname $$file` ; cvs add `basename $$file` ); done"/>
    </exec>
    <exec executable="sh">
      <arg value="-c"/>
      <arg value="cd ${todir} ; cvs -nq update | grep -e '^?' | while read comm file; do ( cd `dirname $$file` ; cvs add `basename $$file` ); done"/>
    </exec>
    <exec executable="sh">
      <arg value="-c"/>
      <arg value="cd ${todir} ; cvs -nq update | grep -e '^?' | while read comm file; do ( cd `dirname $$file` ; cvs add `basename $$file` ); done"/>
    </exec>

    <!-- Should I write
       <cvs cvsRoot="${cvs.root}" command="commit" package="${todir}"/>
       or
       <cvs cvsRoot="${cvs.root}" command="commit" dest="${todir}"/>
       ?
      -->
    <exec executable="sh">
      <arg value="-c"/>
      <arg value="cd ${todir} ; cvs commit -m'Updates.'"/>
    </exec>

  </target>

  <target name="testing-commit-files" depends="init">
    <property name="dir" value="${working.dir}/testing"/>
    <copy todir="${dir}" file="build.xml"/>
    <antcall target="commit-files">
      <param name="todir" value="www/linus/testing"/>
      <param name="fromdir" value="${dir}"/>
    </antcall>
  </target>
  
  <target name="commit-files-2">
    <property name="to.dir" location="${in.todir}"/>
    <property name="from.dir" location="${in.fromdir}"/>
    <property name="cvs-add-ant.xsl" location="${xsl.dir}/cvs-add-ant.xsl"/>
    <property name="cvs-add-ant.xsl" location="${xsl.dir}/cvs-add-ant.xsl"/>
  
    <property name="fromdir-fs.xml" location="${working.dir}/fromdir-fs.xml"/>
    <property name="todir-fs.xml" location="${working.dir}/todir-fs.xml"/>
    <property name="cvs-add-ant.xml" location="${working.dir}/cvs-add-ant.xml"/>
    <property name="cvs-remove-ant.xml" location="${working.dir}/cvs-remove-ant.xml"/>
    
    <!-- Create directory in case it not exists yet. -->
    <mkdir dir="${to.dir}"/>

    <!-- Take care that everything in the todir is up to date -->
    <delete>
      <fileset dir="${to.dir}" excludes="CVS CVS/*"/>
    </delete>
    <cvs cvsRoot="${cvs.root}" command="update -A -d" dest="${to.dir}"/>
    
    <!-- Create an xml file with an overview of all files in the todir -->

    <fileset id="todir-fs" dir="${to.dir}"/>

    <pathconvert property="todir-fs.tmp" refid="todir-fs" pathSep="&lt;/pathelement&gt;&lt;pathelement&gt;"/>
    <property name="todir-fs-xml" value="&lt;path&gt;&lt;pathelement&gt;${todir-fs.tmp}&lt;/pathelement&gt;&lt;/path&gt;"/>

    <echo file="${todir-fs.xml}">${todir-fs-xml}</echo>

    <!-- Create an xml file with an overview of all files in fromdir                             -->
    <!-- Extra trick: map in the resulting xml file the fromdir directory to the todir directory -->
    <fileset id="fromdir-fs" dir="${from.dir}"/>

    <pathconvert property="fromdir-fs.tmp" refid="fromdir-fs" pathSep="&lt;/pathelement&gt;&lt;pathelement&gt;">
      <map from="${from.dir}" to="${to.dir}"/>
    </pathconvert>
    <property name="fromdir-fs-xml" value="&lt;path&gt;&lt;pathelement&gt;${fromdir-fs.tmp}&lt;/pathelement&gt;&lt;/path&gt;"/>

    <echo file="${fromdir-fs.xml}">${fromdir-fs-xml}</echo>

    <!-- Create Ant scripts -->
    
    <style in="fromdir-fs.xml" out="${cvs-add-ant.xml}" style="${cvs-add-ant.xsl}">
      <param name="todir" expression="todir-fs.xml"/>
    </style>

    <style in="${todir-fs.xml}" out="${cvs-remove-ant.xml}" style="${cvs-remove-ant.xsl}">
      <param name="fromdir" expression="fromdir-fs.xml"/>
    </style>

    <!-- Make new version of the todir -->
    
    <delete>
      <fileset dir="${to.dir}" excludes="CVS CVS/*"/>
    </delete>
    <copy todir="${to.dir}">
      <fileset dir="${from.dir}"/>
    </copy>
    
    <!-- Call ant scripts -->
    <ant antfile="${cvs-add-ant.xml}"/>
    <ant antfile="${cvs-remove-ant.xml}"/>
    
    <!-- Commit it all -->
    <echo>Commiting: ${in.message}</echo>
    <cvs command="commit -m${in.message} ${to.dir}" cvsRoot="${cvs.root}"/>
  </target>

  <target name="testing-commit-files-2" depends="init">
    <echo>CVSROOT is ${cvs.root}</echo>
    <property name="dir" value="${working.dir}/testing-2"/>
    <!--copy todir="${dir}" file="build.xml"/-->

    <antcall target="commit-files-2">
      <param name="in.todir" value="www/michiel/testing"/>
      <param name="in.fromdir" value="${dir}"/>
      <param name="in.message" value="Updates."/>
    </antcall>

    <!--cvschangelog cvsRoot="${cvs.root}" dir="${basedir}" destfile="changelog.xml"/-->
  </target>


  <!-- ================================================================ -->
  <!-- Things that depend on the source of ArgoUML                      -->
  <!-- ================================================================ -->

  <target name="update" depends="init" description="update the project from CVS">
    <echo>CVSROOT is ${cvs.root}</echo>
    <cvs cvsRoot="${cvs.root}" dest="${working.dir}" package="argouml/src_new"/>
    <cvs cvsRoot="${cvs.root}" dest="${working.dir}" package="argouml/src"/>
    <cvs cvsRoot="${cvs.root}" dest="${working.dir}" package="argouml/tests"/>
    <cvs cvsRoot="${cvs.root}" dest="${working.dir}" package="argouml/lib"/>
    <cvs cvsRoot="${cvs.root}" dest="${working.dir}" package="argouml/tools"/>
  </target>

  <target name="compile" depends="update" description="compile the source and assemble other files">
    <ant dir="${argouml.src.dir}" target="compile"/>
  </target>

  <target name="tests" depends="update" description="run unit tests">
    <ant dir="${argouml.src.dir}" target="tests"/>
    <property name="resultdir" value="www/snapshots/${cvs.user}/OS/JDK/tests/reports"/>
    <antcall target="commit-files">
      <param name="todir" value="${resultdir}"/>
      <param name="fromdir" value="${argouml.dir}/build/tests/reports"/>
    </antcall>
  </target>

  <target name="javadocs" depends="update" description="generate javadocs">
    <ant dir="${argouml.src.dir}" target="javadocs"/>
    <!--antcall target="commit-files">
      <param name="todir" value="www/snapshots/${cvs.user}/OS/JDK/javadocs"/>
      <param name="fromdir" value="${working.dir}/argouml/build/javadocs"/>
    </antcall-->
  </target>

  <target name="reports" description="generate reports">
    <copy file="build-reports.xml" todir="${argouml.src.dir}" overwrite="true"/>
    <copy file="reporting.properties" todir="${argouml.src.dir}" overwrite="true"/>
    <copy file="${instrument-ant.xsl}" todir="${argouml.src.dir}/xsl" overwrite="true"/>
    <copy todir="${argouml.dir}/tools">
      <fileset dir="tools">
        <include name="**"/>
        <exclude name="CVS/**"/>
        <exclude name="CVS"/>
      </fileset>
    </copy>
    <ant dir="${argouml.src.dir}" antfile="build-reports.xml"/>
    <!--antcall target="commit-files">
      <param name="todir" value="www/snapshots/${cvs.user}/OS/JDK/javadocs"/>
      <param name="fromdir" value="${working.dir}/argouml/build/javadocs"/>
    </antcall-->
  </target>


  <!-- ================================================================ -->
  <!-- Statistics things                                                -->
  <!-- ================================================================ -->

  <target name="stats-issuezilla" depends="init"></target>

  <target name="stats-commit" depends="init"></target>

  <target name="stats-members" depends="init"></target>

  <target name="stats-mailinglist" depends="init"></target>

</project>
